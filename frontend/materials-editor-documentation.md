# Документация по работе редактора материалов

## Общее описание

Редактор материалов - это комплексный инструмент для создания, редактирования и предварительного просмотра различных типов материалов в системе. Он поддерживает три основных типа материалов:

1. **Task** - задания/задачи
2. **Adaptive Playlist** - адаптивные плейлисты
3. **Linear Playlist** - линейные плейлисты

## Архитектура редактора

### Основные компоненты

#### MaterialUpsertWidget
Виджет создания и редактирования материалов, который предоставляет унифицированный интерфейс для работы с различными типами материалов.

**Props:**
- `id` (string, optional) - ID материала для редактирования
- `folderId` (string, nullable) - ID папки, в которой создается/редактируется материал
- `isOpen` (boolean) - флаг открытия виджета
- `onClose` (function) - функция закрытия виджета
- `type` (string) - тип материала ('task', 'playlist-adaptive', 'playlist-linear')
- `onSave` (function) - функция сохранения материала

#### MaterialPreviewWidget
Виджет предварительного просмотра материалов.

**Props:**
- `materialId` (string) - ID материала для просмотра
- `isOpen` (boolean) - флаг открытия виджета
- `onClose` (function) - функция закрытия виджета

### Типы материалов

#### Task (Задание)
Представляет собой отдельное задание с контентом и механиками.

**Структура:**
```typescript
type ITaskMaterial = IBaseMaterial & {
  type: 'task';
  entity: {
    content: {
      config: IEditorValue;
      blocks: IMechanicsConfig[];
      groups: IMechanicsGroup[];
    };
  };
  reviewRequired: boolean;
};
```

#### Adaptive Playlist (Адаптивный плейлист)
Плейлист с адаптивной логикой прохождения материалов.

**Структура:**
```typescript
type IAdaptivePlaylistMaterial = IBaseMaterial & {
  type: 'playlist-adaptive';
  entity: {
    id: string;
    flow: IGraph;
    materials: IMaterialListItem[];
  };
};
```

#### Linear Playlist (Линейный плейлист)
Плейлист с линейной последовательностью материалов.

**Структура:**
```typescript
type ILinearPlaylistMaterial = IBaseMaterial & {
  type: 'playlist-linear';
  entity: {
    id: string;
    flow: IGraph;
    materials: IMaterialListItem[];
  };
};
```

## Процесс создания и редактирования материалов

### 1. Инициализация редактора

При создании нового материала или редактировании существующего используется `MaterialUpsertWidget`, который в зависимости от типа материала отображает соответствующий редактор:

- Для типа 'task' - `TaskEditor`
- Для типа 'playlist-adaptive' - `AdaptivePlaylistEditor`
- Для типа 'playlist-linear' - `LinearPlaylistEditor`

### 2. Загрузка данных

При редактировании существующего материала происходит загрузка данных через хуки:
- `useMaterialOptionalAsync` - для загрузки материала по ID
- Проверка типа материала для обеспечения корректного отображения

### 3. Редактирование контента

#### Task Editor
Редактирование заданий происходит через `TaskContentEditor`, который предоставляет:
- Редактор контента задания на основе Slate.js и Plate
- Управление механиками и группами
- Валидацию контента

##### Архитектура редактора контента заданий

Редактор контента заданий построен на основе Slate.js и Plate - мощных библиотек для создания редакторов контента.

**Основные компоненты:**

1. **TaskContentEditorProvider** - провайдер контекста редактора, который:
   - Инициализирует редактор Slate с необходимыми плагинами
   - Настраивает компоненты для отображения элементов
   - Обеспечивает интеграцию с системой механик

2. **RichContentProvider** - провайдер редактора контента, который:
   - Создает экземпляр редактора Plate
   - Настраивает плагины для работы с медиа и другими элементами
   - Обеспечивает загрузку ресурсов

3. **TaskContentEditor** - компонент редактора, который:
   - Отображает визуальный редактор контента
   - Обрабатывает изменения контента
   - Передает изменения в родительские компоненты

##### Плагины Slate/Plate

Редактор использует расширяемую архитектуру плагинов Slate/Plate:

**Базовые плагины:**
- `createBoldPlugin`, `createItalicPlugin`, `createUnderlinePlugin`, `createStrikethroughPlugin` - плагины форматирования текста
- `createParagraphPlugin`, `createHeadingPlugin` - плагины текстовых блоков
- `createAlignPlugin` - плагин выравнивания
- `createTablePlugin` - плагин таблиц
- `createListPlugin` - плагин списков
- `createLinkPlugin` - плагин ссылок
- `createHorizontalRulePlugin` - плагин горизонтальных линий
- `createSpoilerPlugin` - плагин спойлеров

**Плагины медиа:**
- `createImagePlugin` - плагин изображений
- `createAudioPlugin` - плагин аудио
- `createMediaEmbedPlugin` - плагин встраиваемых медиа
- `createLatexPlugin` - плагин LaTeX

**Плагины механик:**
- `createMechanicsBlockPlugin` - плагин блочных механик
- `createMechanicsInlinePlugin` - плагин инлайновых механик
- `createMechanicsPlugin` - основной плагин механик с логикой обработки

**Специфические плагины редактора:**
- `createDeletePlugin` - плагин удаления элементов
- `createAutoformatPlugin` - плагин автоформатирования
- `createSoftBreakPlugin` - плагин мягких переносов
- `createExitBreakPlugin` - плагин выхода из блоков
- `createTrailingBlockPlugin` - плагин завершающих блоков
- `createSelectOnBackspacePlugin` - плагин выбора при удалении
- `createNodeIdPlugin` - плагин идентификаторов узлов

##### Компоненты элементов

Каждый тип элемента в редакторе имеет свой компонент отображения:

- `ParagraphElement` - абзац
- `HeadingElement` - заголовки (h1-h6)
- `HrElement` - горизонтальная линия
- `TableElement`, `TableRowElement`, `TableCellElement` - таблицы
- `ImageElement` - изображения
- `AudioElement` - аудио
- `LatexElement` - LaTeX формулы
- `SpoilerElement`, `SpoilerBodyElement` - спойлеры
- `UnorderedListElement`, `OrderedListElement`, `UnorderedListItemElement` - списки
- `LinkElement` - ссылки
- `MediaEmbedElement` - встраиваемые медиа
- `MechanicsElement` - механики (блоковые и инлайновые)

##### Механизмы работы с механиками

Механики - это специальные элементы контента, которые представляют интерактивные компоненты заданий.

**Типы механик:**
- Блочные механики (ELEMENT_MECHANICS_BLOCK) - занимают всю ширину редактора
- Инлайновые механики (ELEMENT_MECHANICS_INLINE) - встраиваются в текст

**Логика работы:**
1. При добавлении механики в редактор создается соответствующий элемент Slate
2. Механика связана с конфигурацией через уникальный ID
3. При удалении элемента механики из редактора, соответствующая конфигурация удаляется из модели
4. При дублировании элемента механики, создается новая конфигурация с уникальным ID

#### Playlist Editors
Редактирование плейлистов происходит через `MaterialsFlow`, который предоставляет:
- Визуальный редактор графа материалов
- Управление узлами и связями
- Поддержку различных типов узлов (материалы, варианты и т.д.)

### 4. Сохранение материалов

Сохранение материалов происходит через мутации:
- `useUpsertTaskAsync` - для заданий
- `useUpsertPlaylistAsync` - для плейлистов

#### Процесс сохранения:
1. Подготовка данных для сохранения
2. Вызов соответствующего API метода (создание или обновление)
3. Обновление кэша данных
4. Вызов callback функции `onSave`

### 5. Автосохранение

Редактор поддерживает автосохранение черновиков:
- Используется `useDebouncedCallback` с задержкой 5 секунд
- Автосохранение происходит только при включенном флаге `withAutosaving`
- Автосохранение отключается при ручном сохранении

## Механизмы валидации

### Валидация Task
Валидация заданий происходит на уровне `TaskContentEditor`:
- Проверка корректности заполнения механик
- Проверка структуры контента
- Отображение ошибок валидации в заголовке редактора

### Валидация Playlist
Валидация плейлистов происходит на уровне API:
- Проверка корректности графа материалов
- Проверка наличия всех материалов в системе

## Работа с черновиками

### Статусы материалов
- `draft` - черновик
- `published` - опубликован
- `draft_ahead_published` - есть неопубликованные изменения

### Управление черновиками
- Возможность сброса черновика к опубликованной версии
- Предварительный просмотр как черновика, так и опубликованной версии
- Автоматическое сохранение черновиков

## Взаимодействие с API

### Методы API для Task
- `createTask` - создание нового задания
- `updateTaskById` - обновление существующего задания

### Методы API для Playlist
- `createPlaylistLinear` - создание линейного плейлиста
- `updatePlaylistLinear` - обновление линейного плейлиста
- `createPlaylistAdaptive` - создание адаптивного плейлиста
- `updatePlaylistAdaptive` - обновление адаптивного плейлиста

### Параметры сохранения
- `saveAs` - статус сохранения ('draft' или 'published')
- `name` - название материала
- `folderId` - ID папки
- `content` - контент материала (для заданий)
- `flow` - граф материалов (для плейлистов)
- `materialIds` - список ID материалов в плейлисте

## Контекст редактора

Редактор использует контекст `MaterialsEditorContext`, который предоставляет:
- Настройки автосохранения
- Общие опции мутаций
- Глобальные настройки редактора

## Особенности работы

### Подтверждение выхода
При наличии несохраненных изменений отображается подтверждение выхода из редактора.

### История изменений
Для заданий поддерживается история изменений с возможностью отмены/повтора действий.

### Предварительный просмотр
Все типы материалов поддерживают предварительный просмотр в отдельном окне.

## Технические детали

### Структура хуков
- `useTaskSave` - хук сохранения заданий
- `usePlaylistSave` - хук сохранения плейлистов
- `useMaterialForm` - хук управления формой материала

### Управление состоянием
Используется `react-query` для управления состоянием данных и мутациями.

### Обработка ошибок
Все ошибки отображаются в интерфейсе с возможностью повторной попытки.