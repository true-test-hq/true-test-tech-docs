# Account Module

## Описание
Модуль `Account` отвечает за управление учетными записями пользователей, аутентификацию и профили.
Он обеспечивает регистрацию, вход в систему (в том числе через социальные сети), управление профилями (администратор, участник) и восстановление доступа.

## Основные возможности
-   **Аутентификация**:
    -   Email/Пароль
    -   Google
    -   Yandex
    -   VK
    -   Mail.ru
-   **Управление аккаунтом**:
    -   Получение публичных данных аккаунта
    -   Обновление информации профиля
    -   Загрузка и удаление аватара
-   **Профили**:
    -   Создание и переключение профилей

### Взаимодействие
1.  При входе в систему или переключении роли выдается **JWT токен**, привязанный к конкретному **активному профилю**.
2.  Если у аккаунта нет профилей (только зарегистрировался), токен содержит `profile: null`.
3.  Создание профиля происходит отдельно после регистрации аккаунта.

## Архитектура и реализация

### Разделение Аккаунт / Профиль
Модуль реализует строгое разделение между учетными данными входа и ролью пользователя в системе.
-   **Account (Аккаунт)**: Содержит данные для входа (email, пароль, внешние провайдеры) и общую информацию (имя, аватар). Аккаунт сам по себе не дает прав доступа к учебным материалам.
-   **Profile (Профиль)**: Определяет роль пользователя (`student` или `teacher`) и привязывается к аккаунту. Один аккаунт может иметь несколько профилей (хотя в текущей реализации активен только один).

### Сервисы
-   **AuthorizationService**: Центральный сервис для аутентификации.
    -   Обрабатывает вход по email/паролю и через внешние сервисы (Google, VK, etc.).
    -   Управляет регистрацией новых пользователей.
    -   Генерирует JWT токены, содержащие информацию об активном профиле.
-   **AccountUpdateService**: Отвечает за обновление данных аккаунта (смена пароля, имени, контактов).
-   **VerificationService**: Управляет процессом верификации email (генерация и проверка токенов).

### Команды (Commands)
В модуле используется паттерн Command для инкапсуляции сложной бизнес-логики.
На данный момент реализована следующая команда:

#### `CreateProfileCommand`
Отвечает за создание профиля пользователя (`StudentProfile` или `TeacherProfile`) и привязку его к существующему аккаунту.

### Репозиторий
**PrismaAccountRepository** (`infrastructure/persistence`) реализует доступ к данным, обеспечивая транзакционную целостность при создании аккаунта и профилей.

## Доменные сущности

### Account (Аккаунт)
Основная сущность пользователя. Представляет учетную запись в системе.

**`publicData`:**
-   `id`: Уникальный идентификатор аккаунта.
-   `firstName`: Имя пользователя.
-   `lastName`: Фамилия пользователя.
-   `middleName`: Отчество пользователя (опционально).
-   `avatar`: URL аватара пользователя.
-   `about`: Информация "О себе" (опционально).
-   `contacts`: Контактная информация:
    -   `email`: Email-адрес и статус верификации (`email`, `isVerified`).
    -   `phone`: Номер телефона (опционально).
    -   `telegram`: Telegram username (опционально).
-   `profilesList`: Список ID всех профилей, привязанных к аккаунту.

**`privateData`:**
-   `login`: Логин для входа в систему.
-   `passwordHash`: Хеш пароля (bcrypt).
-   `createdAt`: Дата создания аккаунта.
-   `inviteId`: ID приглашения, по которому был зарегистрирован аккаунт (опционально).
-   `privileges`: Привилегии аккаунта (битовая маска).
-   `restrictions`: Ограничения аккаунта (битовая маска).

**`activeProfile`:**
-   Ссылка на текущий активный профиль пользователя (`StudentProfile` или `TeacherProfile`).

### TeacherProfile (Профиль администратора)
**Поля:**
-   `id`: Уникальный идентификатор профиля.
-   `type`: Тип профиля (`teacher`).
-   `subject`: Предмет преподавания.
-   `status`: Статус верификации профиля:
    -   `profileNotFilled`: Профиль не заполнен.
    -   `onModeration`: На модерации.
    -   `verified`: Верифицирован.
-   `expiresAt`: Дата истечения срока действия профиля (timestamp, опционально).

### StudentProfile (Профиль участника)
**Поля:**
-   `id`: Уникальный идентификатор профиля.
-   `type`: Тип профиля (`student`).
-   `expiresAt`: Дата истечения срока действия профиля (timestamp, опционально).

## API
Основные контроллеры:
-   `AuthController` (`/api/v1/auth`): Эндпоинты для входа, регистрации и сброса пароля.
-   `AccountController` (`/api/v1/accounts`): Эндпоинты для управления текущим аккаунтом и профилем.
-   `VerificationController` (`/api/v1/verify`): Эндпоинты для верификации email.

## Для новых разработчиков

### Структура модуля
```
account/
├── api/                 # Presentation Layer (контроллеры, DTO)
│   ├── account.adapter.ts
│   ├── account.controller.ts
│   ├── account.dto.ts
│   ├── auth.controller.ts
│   ├── auth.dto.ts
│   ├── verification.controller.ts
│   ├── verification.dto.ts
│   └── types.ts
├── infrastructure/     # Infrastructure Layer (реализации интерфейсов)
│   ├── external-services/  # Интеграции с внешними OAuth провайдерами
│   │   ├── google/
│   │   ├── mail-ru/
│   │   ├── vk-com/
│   │   └── yandex/
│   ├── persistence/       # Реализации репозиториев
│   │   └── repositories/
│   └── services/         # Адаптеры для внешних сервисов
├── model/               # Domain Layer (сущности, сервисы, интерфейсы)
│   ├── domain/          # Доменные объекты и сервисы
│   ├── services/         # Сервисы уровня приложения
│   └── interfaces/       # Интерфейсы для внешних зависимостей
└── index.ts            # Экспорт модуля
```

### Основные потоки данных

1. **Регистрация нового пользователя**:
   - Контроллер AuthController получает запрос на регистрацию
   - AuthorizationService создает новый аккаунт
   - Генерируется JWT токен с profile: null
   - Возвращается токен клиенту

2. **Создание профиля**:
   - Контроллер AccountController получает запрос на создание профиля
   - Создается экземпляр CreateProfileCommand
   - Команда создает профиль и связывает его с аккаунтом
   - Обновляется активный профиль в аккаунте

3. **Аутентификация через OAuth**:
   - Контроллер AuthController получает код от провайдера
   - Соответствующий сервис (GoogleAuthService, VKComAuthService и т.д.) обменивает код на токен
   - Получаются данные пользователя от провайдера
   - Если аккаунт существует - генерируется токен, если нет - создается новый аккаунт

### Интеграции с другими модулями

- **Assignments**: Предоставляет данные профилей через AccountsServiceForInvites
- **Events**: Предоставляет данные профилей через AccountsServiceForEvents
- **Invites**: Предоставляет данные профилей через AccountsServiceForInvites
- **SMTP**: Используется для отправки писем верификации

### Важные особенности

- Все пароли хранятся в виде хешей с использованием bcrypt
- JWT токены содержат информацию о профиле пользователя
- Поддерживается верификация email через токены
- Реализована интеграция с 4 OAuth провайдерами
- Модуль использует Dependency Injection для подключения зависимостей
- Для работы с базой данных используется Prisma ORM
