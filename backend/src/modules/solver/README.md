# Solver Module

## Описание
Модуль `Solver` ("Решатель") является ядром системы тестирования.
Он управляет процессом прохождения заданий, сессиями, проверкой ответов и навигацией по материалам.

## Основные возможности
-   **Сессии решения (Solve Session)**:
    -   Запуск сессии (по материалу или мероприятию).
    -   Получение конфигурации и текущей задачи.
    -   Отправка ответов и получение результата.
    -   Навигация (переход к следующей задаче).
    -   Пауза и завершение сессии.
-   **Прокторинг**:
    -   Проверка устройства перед началом.
    -   Сбор отчетов прокторинга.
-   **Отчеты**:
    -   Получение отчетов по сессиям (для customer).

## Доменные сущности

### SessionAggregate (Сессия участника)
Основной агрегат, хранящий состояние прохождения теста участником.

**Поля:**
-   `id`: Уникальный идентификатор сессии.
-   `participantId`: ID участника.
-   `participantName`: Имя участника.
-   `outerId`: Внешний ID сессии (опционально).
-   `scope`: Область видимости сессии (опционально).
-   `type`: Тип сессии (`platform`, `event`, `external`).
-   `status`: Статус сессии:
    -   `on_disclaimer`: На экране предупреждения.
    -   `on_proctoring_check`: Проверка прокторинга.
    -   `active`: Активна (участник решает задачи).
    -   `paused`: Приостановлена.
    -   `finished_by_participant` / `finished_by_timeout` / `finished_by_admin`: Завершена.
-   `eventId` / `accessId`: ID мероприятия и доступа (для сессий мероприятий).
-   `score` / `maxScore`: Текущий и максимальный баллы.
-   `timeSpent`: Время, затраченное на решение (миллисекунды).
-   `startsAt` / `endsAt`: Время начала и окончания сессии.
-   `realStart` / `realEnd`: Фактическое время начала и завершения.
-   `meta`: Метаданные сессии:
    -   `rootMaterial`: Корневой материал сессии (ID, имя).
    -   `plugins`: Список активных плагинов (прокторинг).
    -   `type`: Тип материала.
    -   `solverStatus`: Состояние решателя (`ongoing`, `on_confirmation`, `finished`).
    -   `initialTimeLimits`: Начальные ограничения времени.
    -   `isDev`: Флаг режима разработки.
    -   `proceededTasks`: Список решенных задач с ответами, баллами, временем.
    -   `lastVisitedTaskTimeStamp`: Время последнего посещения задачи.
    -   `currentTaskIndex`: Индекс текущей задачи.
    -   `allTasksVisited`: Флаг посещения всех задач.
    -   `wasAtLeastOneTaskRequested`: Флаг запроса хотя бы одной задачи.
    -   `reviewRequired`: Требуется ли проверка.
    -   `preparedFeedback`: Подготовленная обратная связь.
    -   `teacherSummary`: Комментарий преподавателя.
    -   `currentScore` / `maxScore`: Текущие баллы.
    -   `currentOverriddenScore` / `maxOverriddenScore`: Переопределенные баллы.
    -   `anticheatData`: Данные античита:
        -   `sign`: Уникальная подпись (токен) текущей активной сессии. Используется для валидации запросов и предотвращения одновременного использования сессии в нескольких вкладках/устройствах.
        -   `signRegenerations`: Количество раз, когда подпись была перегенерирована (например, при входе с нового устройства).
        -   `attemptsWithWrongIdent`: Количество попыток доступа с неверной подписью.
    -   `taskReloads`: Счетчик перезагрузок задач.
    -   `approximateTasksCount`: Приблизительное количество задач.
    -   `calculateApproximateTasksCount`: Флаг расчета количества задач.
    -   `xStateFlow`: Состояние XState машины.
    -   `locatorContext`: Контекст навигации (XState FSM).
    -   `previouslySeenVariantsMap`: Мапа просмотренных вариантов задач (`Record<variantNodeId, materialId[]>`). Используется в механике "Варианты" (Variants) для выдачи уникальных задач. Если участник уже видел все задачи из набора, история сбрасывается и цикл начинается заново.
    -   `lastUserCausedSolverStatus`: Последний статус, вызванный пользователем.
    -   `urlToken`: Токен URL (опционально).
-   `showFeedback` / `showSolution`: Показывать ли обратную связь и правильные ответы по окончанию тестирования.

## API
Основные контроллеры:
-   `SolverController` (`/api/v1/solver`): Основное API для прохождения тестов.
-   `SolverMaterialController` (`/api/v1/materials`): Запуск сессии по материалу.
-   `SolverPublicController` (`/api/v1/public-solver`): Публичные методы (проверка устройства).
-   `ReportsController` (`/api/v1/customer-solver/report`): Отчеты.
-   `ProctoringController` (`/api/v1/proctoring`): Хуки для прокторинга.

## Логика работы

### Хранение материалов (Граф)
Материалы (плейлисты) хранятся в виде **графа** (`IGraph`).
Граф состоит из узлов (`nodes`) и ребер (`edges`).

Типы узлов:
-   `material`: Узел с учебным материалом (задача или вложенный плейлист).
-   `conditional`: Условный переход (ветвление в зависимости от баллов).
-   `random`: Случайный выбор следующего узла.
-   `variants`: Группа вариантов задач (выбирается один из вариантов).
-   `finish`: Конец плейлиста.

### Валидация графа
При обновлении или создании плейлиста происходит валидация графа (`validatePlaylistGraphAndAddBackendData`).
Проверяется:
1.  **Наличие Start/Finish**: Должен быть ровно один стартовый узел (без входящих ребер, кроме корня) и хотя бы один конечный узел.
2.  **Связность**: Все узлы должны быть достижимы.
3.  **Циклы**: Отсутствие явных и неявных циклов.
4.  **Покрытие условий**: Для `conditional` узлов проверяется, что все возможные диапазоны баллов покрыты переходами.
5.  **Множественные выходы**: Узлы типа `material` и `variants` не могут иметь более одного исходящего ребра (ветвление только через `conditional` или `random`).
6.  **Корректность концов**: Плейлист не может заканчиваться узлом `conditional` или `random`.

## Архитектура и реализация

### Основные компоненты
-   **SessionAggregate**: Центральный агрегат. Хранит все состояние сессии, историю переходов, ответы и метаданные.
-   **Locators (Навигаторы)**: Отвечают за определение следующего шага в тесте.
    -   `XStateLocator`: Использует конечный автомат (`xstate`) для навигации по графу плейлиста.
### Запуск теста (FSM)
При старте сессии участником, граф материала конвертируется в **Конечный Автомат (Finite State Machine - FSM)**.
Для этого используется библиотека `xstate`.
-   **Solvers (Решаторы)**: Отвечают за проверку ответов пользователя.
    -   `V1Solver`: Реализует логику проверки для различных механик (выбор ответа, ввод текста, сортировка и т.д.).

### Команды (Commands)
Модуль использует паттерн Command для управления жизненным циклом сессии.
-   **`EventStartNewSessionCommand`**: Создает новую сессию для мероприятия.
-   **`StartPreparedSessionCommand`**: Переводит сессию из состояния `on_disclaimer` в `active` (начало решения).
-   **`PauseSessionCommand` / `FinishSessionCommand`**: Приостанавливает или завершает сессию.
-   **`PingSessionCommand`**: Обновляет время последней активности ("heartbeat").
-   **`ProceedAnswerSessionCommand`**: Принимает ответ пользователя, проверяет его (через Solver), обновляет состояние сессии и определяет следующий шаг (через Locator).
-   **`UpdateAnswerSessionCommand`**: Обновляет ответ на текущий вопрос без перехода к следующему (сохранение черновика ответа).
-   **`MoveToTaskSessionCommand`**: Переход к произвольной задаче (если разрешено навигацией).
-   **`RecalculateSessionCommand`**: Пересчитывает баллы сессии (используется при изменении корректных ответов или добавлении новых черз веер ответов).
-   **`PlatformStartSessionCommand`**: Запуск сессии для платформенных (внутренних) тестов.

## Для новых разработчиков

### Структура модуля
```
solver/
├── api/                 # Presentation Layer (контроллеры, DTO)
├── model/              # Domain Layer (сущности, сервисы, интерфейсы)
│   ├── domain/          # Доменные объекты (SessionAggregate, Locators, Solvers)
│   ├── services/        # Сервисы уровня приложения
│   └── interfaces/      # Интерфейсы
└── infrastructure/       # Infrastructure Layer
    ├── persistence/     # Репозитории
    └── services/       # Адаптеры
```

### Основные потоки данных

1.  **Запуск сессии (Start Session)**:
    -   Клиент вызывает API (например, `/api/v1/materials/:id/start`).
    -   Контроллер создает команду `EventStartNewSessionCommand` (или аналогичную).
    -   Команда создает `SessionAggregate`.
    -   Агрегат инициализирует FSM (через `XStateLocator`), строит граф материала.
    -   Сессия сохраняется в БД.

2.  **Отправка ответа (Submit Answer)**:
    -   Клиент отправляет ответ (`POST /api/v1/solver/session/answer`).
    -   Контроллер вызывает `ProceedAnswerSessionCommand`.
    -   Команда загружает агрегат.
    -   Агрегат вызывает `V1Solver` для проверки ответа.
    -   Результат проверки передается в `XStateLocator`.
    -   FSM совершает переход (Transition) в следующее состояние.
    -   Обновленное состояние сохраняется.

### Важные особенности
-   **XState**: Вся навигация построена на конечных автоматах. Граф материала превращается в FSM.
-   **SessionAggregate**: "Толстый" агрегат, содержащий всю бизнес-логику сессии.
-   **Command Pattern**: Все изменения состояния идут через команды.
