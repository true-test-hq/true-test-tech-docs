# Solver Locators

## Описание
Директория `locators` содержит логику навигации по графу материалов (плейлистов).
Основная задача локатора — определить, какой узел графа должен быть следующим, основываясь на текущем состоянии и результатах прохождения предыдущих узлов.

## Основные компоненты

### `XStateLocator`
Класс-обертка над конечным автоматом (FSM), созданным с помощью библиотеки `xstate`.
-   **Состояние**: Хранит текущий узел (`currentState`), набранные баллы (`score`), текущий материал (`currentTaskMaterialId`) и тип задачи.
-   **Переходы**: Обрабатывает событие `NEXT`, принимая на вход баллы за пройденную задачу.
-   **Guards**: Использует условия для определения пути в графе:
    -   `scoreGte`: Текущий балл **больше или равен** заданному (`>=`).
    -   `scoreLte`: Текущий балл **меньше или равен** заданному (`<=`).
    -   `scoreLe`: Текущий балл **строго меньше** заданного (`<`).
    -   `scoreEq`: Текущий балл **равен** заданному (`==`).
    -   `random`: Случайный переход.

### `validatePlaylistGraphAndAddBackendData`
Функция валидации графа перед его использованием или сохранением.
Проверяет:
-   Наличие стартового и конечного узлов.
-   Отсутствие "висячих" узлов.
-   Покрытие всех диапазонов баллов для условных переходов (`conditional`).
-   Отсутствие недопустимых циклов (в адаптивных плейлистах).

### `convertMaterialIntoXStateRepresentation`
Функция конвертации графа (`IGraph`) в конфигурацию машины состояний XState.
    1.  Каждый узел графа преобразуется в состояние (State) автомата.
    2.  Ребра графа преобразуются в переходы (Transitions).
    3.  **Conditional** узлы превращаются в переходы с условиями (Guards) на основе баллов (`scoreGte`, `scoreLte` и т.д.).
    4.  **Random** узлы превращаются в переходы с вероятностным выбором.
    5.  **Variants** узлы разворачиваются: выбирается вариант, который пользователь еще не видел (или случайный, если видел все).
    6.  Рекурсивно обрабатывает вложенные плейлисты.

## Для новых разработчиков

### Как определяется следующий шаг?
1.  Пользователь отправляет ответ.
2.  Ответ проверяется и начисляются баллы.
3.  В машину состояний (`XStateLocator`) отправляется событие `NEXT` с payload `{ score: ... }`.
4.  Машина состояний проверяет текущее состояние и исходящие переходы (Transitions).
5.  Если переход имеет условие (Guard), оно проверяется (например, `score >= 50`).
6.  Если условие выполняется, машина переходит в новое состояние.
7.  Новое состояние соответствует следующему узлу графа (задаче или плейлисту).

### Важные моменты
-   **XState**: Мы используем библиотеку `xstate` версии 4.
-   **Динамическое построение**: Машина состояний строится динамически для каждой сессии на основе графа материала.
-   **Плоская структура**: Вложенные плейлисты "разворачиваются" (flattened) в единый граф состояний. Иерархические состояния XState не используются для вложенности плейлистов.
