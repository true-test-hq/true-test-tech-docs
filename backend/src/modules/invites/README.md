# Invites Module

## Описание
Модуль `Invites` отвечает за создание приглашений.
В используется во внешнем сервисе (например телеграм ботом) для генерации инвайт-ссылок.
Инвайт-ссылки могут задавать профиль, с которым будет создан пользователь, а также список материалов,
которые будут скопированы на его аккаунт.

## Доменные сущности

### Invite (Приглашение)
Приглашение для регистрации новых пользователей. Может быть создано администратором или ботом.

**Поля:**
-   `id`: Уникальный идентификатор приглашения.
-   `creator`: ID создателя приглашения.
-   `tag`: Тег для категоризации приглашений.
-   `usesLeft`: Количество оставшихся использований (`null` = безлимитно).
-   `expirationDate`: Дата истечения срока действия приглашения (timestamp, опционально).
-   `data`: Данные приглашения (`InviteData`):
    -   **Тип `invite_administrator`**:
        -   `foldersToCopy`: Список ID папок для копирования новому пользователю.
        -   `timeLimit`: Ограничение времени действия аккаунта (миллисекунды).
    -   **Тип `invite_student`**:
        -   `assignToTeacherId`: ID администратора, к которому будет привязан участник.
        -   `addToGroupIds`: Список ID групп для добавления.
        -   `accessId`: ID доступа к мероприятию (опционально).
        -   `timeLimit`: Ограничение времени действия аккаунта.

## API
Основные контроллеры:
-   `InvitesController` (`/api/v1/invites`):
    -   `POST /bot/create`: Создание приглашения (требуется соль для безопасности).

## Архитектура и реализация

### Основные компоненты
-   **InvitesService**: Сервис уровня приложения. Управляет созданием и обработкой приглашений.
-   **InviteAggregate**: Доменный агрегат. Содержит данные приглашения (`InviteData`), тег, срок действия и количество оставшихся использований.
    -   Поддерживает типы: `invite_administrator` (копирование папок) и `invite_student` (привязка к администратору, добавление в группы).
-   **IInvitesRepository**: Интерфейс для сохранения и загрузки приглашений.

### Команды (Commands)
Модуль использует паттерн Command для создания и применения приглашений.
-   **`CreateBotInviteCommand`**: Создает приглашение от имени бота (системное).
-   **`CreateTeacherPersonalCommand`**: Создает персональное приглашение от администратора для участников.
    -   Автоматически привязывает участника к администратору.
    -   Может добавлять участника в определенные группы.
-   **`ProceedInviteCommand`**: Обрабатывает применение приглашения при регистрации нового аккаунта.
    -   Создает профиль (администратора или участника) в зависимости от типа инвайта.
    -   Выполняет действия инвайта (копирование папок, добавление в группы).
-   **`ProceedInviteForExistingAccountCommand`**: Применяет приглашение к уже существующему аккаунту.
    -   Позволяет добавить роль (например, стать участником, если был только администратором) или обновить связи (добавиться к новому администратору).

## Для новых разработчиков

### Структура модуля
```
invites/
├── api/                 # Presentation Layer (контроллеры, DTO)
├── infrastructure/     # Infrastructure Layer (реализации интерфейсов)
│   ├── accounts.native.service.ts
│   ├── events.native.service.ts
│   ├── folders.native.service.ts
│   ├── groups.native.service.ts
│   └── invites.repository.ts
├── model/               # Domain Layer (сущности, сервисы, интерфейсы)
│   ├── domain/
│   └── services/
└── index.ts             # Экспорт модуля
```

### Основные потоки данных

1. **Создание приглашения ботом**:
   - Контроллер InvitesController получает запрос на создание приглашения
   - InvitesService создает экземпляр CreateBotInviteCommand
   - Команда создает приглашение и сохраняет его в репозитории

2. **Применение приглашения при регистрации**:
   - При регистрации нового аккаунта вызывается ProceedInviteCommand
   - Команда создает профиль и выполняет действия инвайта
   - Обновляются связи с администратором и группами

### Интеграции с другими модулями

- **Accounts**: Для создания профилей и проверки связей
- **Events**: Для назначения доступа к мероприятиям
- **Folders**: Для копирования папок новым пользователям
- **Groups**: Для добавления участников в группы

### Важные особенности

- Поддерживаются два типа приглашений: для администраторов и для участников
- Приглашения могут иметь ограничения по времени и количеству использований
- Модуль использует Dependency Injection для подключения зависимостей
- Для работы с базой данных используется Prisma ORM
- Все операции происходят через команды
