# Materials Module

## Описание
Модуль `Materials` отвечает за управление учебными материалами: задачами, плейлистами (адаптивными и линейными).
Позволяет создавать, редактировать, клонировать и организовывать материалы в папки.

## Основные возможности
-   **Управление материалами**:
    -   CRUD операции для задач и плейлистов.
    -   Клонирование материалов.
    -   Переименование.
    -   Управление статусом (черновик/опубликовано).
    -   Сброс черновика.
-   **Организация**:
    -   Перемещение материалов между папками.
    -   Массовое удаление.

## Доменные сущности

### Material (Материал)
Базовая сущность, представляющая собой единицу учебного контента.

**Общие поля:**
-   `id`: Уникальный идентификатор материала.
-   `authorId`: ID автора материала (профиль создателя).
-   `creatorId`: ID создателя (может быть бот или администратор).
-   `creatorType`: Тип создателя (`teacher` или `bot`).
-   `createdAt`: Дата создания (timestamp).
-   `updatedAt`: Дата последнего обновления (timestamp).
-   `deletedAt`: Дата удаления (timestamp, опционально) - для soft delete.
-   `name`: Название материала.
-   `folderId`: ID папки, в которой находится материал (опционально).
-   `status`: Статус материала (`draft`, `published`, `draft_ahead_published`).
-   `publishedAt`: Дата публикации (timestamp, опционально).
-   `publishedScore`: Балл опубликованной версии (опционально).

**Версионирование:**
-   Материал хранит две версии контента: **Draft** (рабочая копия) и **Published** (доступная участникам).
-   Редактирование всегда происходит в `draft`.
-   Публикация копирует `draft` в `published`.

### Task (Задача)
Атомарная единица контента.

**Специфичные поля Task (дополнительно к полям Material):**
-   `draft`: Черновая версия задачи:
    -   `content`: Условие задачи (текст, формулы, изображения).
    -   `mechanic`: Тип механики (выбор ответа, ввод текста, сортировка и т.д.).
    -   `answers`: Варианты ответов с отметкой правильных.
    -   `score`: Максимальное количество баллов за задачу.
    -   `solution`: Решение задачи (отображается участнику после ответа).
-   `published`: Опубликованная версия задачи (аналогичная структура).
-   `additionalAnswers`: Дополнительные (альтернативные) правильные ответы.

### Playlist (Плейлист)
Упорядоченный набор задач.

**Поля (дополнительно к базовым полям `Material`):**
-   `flow`: Граф переходов между задачами (IGraph). Определяет порядок и условия перехода.

**Типы плейлистов:**
-   **Linear (Линейный)**: Задачи идут строго одна за другой.
-   **Adaptive (Адаптивный)**: Последовательность задач определяется графом и зависит от ответов участника (ветвление).

## Архитектура и реализация

### Паттерн CQS (Command Query Segregation)
-   **MaterialsService**: Выступает в роли фасада. Он не содержит сложной бизнес-логики, а делегирует выполнение операций специальным **Command** классам.

### Команды (Commands)
Вся бизнес-логика инкапсулирована в командах:
-   **`CreateTaskCommand`**: Создает новую задачу. Может создать сразу опубликованную версию (с валидацией через Solver) или черновик.
-   **`CreatePlaylistCommand`**: Создает новый плейлист. Валидирует граф переходов через Solver.
-   **`UpdateTaskCommand`**: Обновляет задачу. При публикации валидирует контент и обновляет `published` версию. Если сохраняется черновик, статус меняется на `draft_ahead_published`.
-   **`UpdatePlaylistCommand`**: Обновляет плейлист. Аналогично задаче, валидирует граф при публикации.
-   **`UpdateTaskAdditionalAnswersCommand`**: Обновляет список дополнительных (альтернативных) ответов для задачи (Вызывается в веер ответов).
-   **`DeepCopyMaterialCommand`**: Создает полную копию материала. Для плейлистов копирование происходит рекурсивно (копируются все вложенные задачи и плейлисты).
-   **`ResetDraftMaterialCommand`**: Сбрасывает черновик (`draft`) к состоянию опубликованной версии (`published`), отменяя несохраненные изменения.
-   **`MarkAsDeletedMultipleMaterialCommand`**: Помечает список материалов как удаленные (soft delete).
-   **`RenameMaterialCommand`**: Изменяет название материала.
-   **`ChangeFolderMultipleMaterialCommand`**: Перемещает список материалов в другую папку.

### Интеграция с Solver (Валидация)
Модуль `materials` тесно взаимодействует с модулем `solver` для валидации контента.
-   **ISolverService**: Интерфейс, через который команды обращаются к логике солвера.
-   **SolverService (Adapter)**: Реализация интерфейса в `infrastructure/services`. Он использует `OutputSolverServiceForMaterials` из модуля `solver`.
-   **Валидация графа**: При создании или обновлении плейлиста (`CreatePlaylistCommand`, `UpdatePlaylistCommand`) граф переходов передается в `solver` для проверки корректности (отсутствие циклов, висячих узлов и т.д.) через метод `validatePlaylistGraphAndAddBackendData`.

### Deep Copy (Глубокое копирование)
Логика глубокого копирования материалов (`DeepCopyMaterialCommand`).
-   Для **задач**: Создается полная копия записи.
-   Для **плейлистов**: Копирование происходит рекурсивно. Копируется сам плейлист и все вложенные в него материалы (задачи и под-плейлисты), чтобы новый владелец получил полностью независимую копию структуры.

### Репозиторий
**PrismaMaterialsRepository** (`infrastructure/persistence`) отвечает за все операции с базой данных, включая транзакционное сохранение версий материала.

## API
Основные контроллеры:
-   `MaterialController` (`/api/v1/materials`): Основные операции с материалами.
-   `UserMaterialsController` (`/api/v1/me/materials`): Операции с материалами текущего пользователя.

## Для новых разработчиков

### Структура модуля
```
materials/
├── api/                 # Presentation Layer (контроллеры, DTO)
├── infrastructure/     # Infrastructure Layer (реализации интерфейсов)
│   ├── persistence/
│   └── services/
├── model/               # Domain Layer (сущности, сервисы, интерфейсы)
│   ├── domain/
│   │   ├── commands/
│   │   └── interfaces/
│   └── services/
└── index.ts             # Экспорт модуля
```

### Основные потоки данных

1. **Создание задачи**:
   - Контроллер MaterialController получает запрос на создание задачи
   - MaterialsService создает экземпляр CreateTaskCommand
   - Команда валидирует контент через Solver и создает задачу

2. **Публикация материала**:
   - Контроллер MaterialController получает запрос на публикацию
   - MaterialsService создает экземпляр UpdateTaskCommand или UpdatePlaylistCommand
   - Команда валидирует контент и обновляет опубликованную версию

3. **Глубокое копирование**:
   - Контроллер MaterialController получает запрос на копирование
   - MaterialsService создает экземпляр DeepCopyMaterialCommand
   - Команда рекурсивно копирует материал и все вложенные элементы

### Интеграции с другими модулями

- **Solver**: Для валидации контента и графов переходов
- **Folders**: Для организации материалов в папки
- **Events**: Для использования материалов в мероприятиях

### Важные особенности

- Поддерживается версионирование материалов (черновик/опубликовано)
- Реализована система глубокого копирования материалов
- Модуль тесно интегрирован с Solver для валидации контента
- Модуль использует Dependency Injection для подключения зависимостей
- Для работы с базой данных используется Prisma ORM
- Вся бизнес-логика инкапсулирована в командах
