# Events Module

## Описание
Модуль `Events` отвечает за управление мероприятиями (соревнованиями, экзаменами, тестами).
Это один из ключевых модулей системы, обеспечивающий проведение сессий решения задач с различными правилами доступа и аналитикой.

## Основные возможности
-   **Управление мероприятиями**:
    -   CRUD операции для мероприятий.
    -   Запуск и остановка мероприятий.
    -   Пересчет результатов.
-   **Управление доступом (Event Access)**:
    -   Создание различных типов доступа: внутренний (для пользователей системы), внешний (по токену), публичный.
    -   Блокировка/разблокировка доступа.
    -   Генерация ссылок для внешнего доступа.
-   **Сессии (Sessions)**:
    -   Запуск сессий решения (внутренних, внешних, публичных).
    -   Получение истории и обзора сессий.
    -   Экспорт результатов в CSV.
-   **Аналитика**:
    -   Статистика по ответам.
    -   Разнообразие ответов (Answers Diversity).
    -   Рейтинговые таблицы.

## Доменные сущности

### Event (Мероприятие)
Основной агрегат для проведения экзаменов.

**Поля:**
-   `id`: Уникальный идентификатор мероприятия.
-   `ownerId`: ID владельца (профиль администратора).
-   `createdAt`: Дата создания мероприятия (timestamp).
-   `name`: Название мероприятия.
-   `material`: Материал для решения (задача или плейлист):
    -   `id`: ID материала.
    -   `name`: Название материала.
    -   `type`: Тип материала (`task`, `playlist-linear`, `playlist-adaptive`).
    -   `score`: Максимальный балл (для `task` и `playlist-linear`) или `null` (для `playlist-adaptive`).
-   `state`: Статус мероприятия:
    -   `awaiting_participant`: Ожидает участников.
    -   `active`: Активно, участники могут решать задачи.
    -   `finished`: Завершено.
-   `materialDuration`: Ограничение времени на прохождение (минуты, опционально).
-   `showDisclaimer`: Показывать дисклеймер перед началом.
-   `showSolution`: Показывать верные ответы по окончанию тестирования.
-   `showFeedback`: Показывать обратную связь.
-   `scoreOverride`: Переопределение финального балла, которое выдается за тестирование (баллы за задания изменятся пропорционально).
-   `accesses`: Список правил доступа (`Map<accessId, EventAccessAggregate>`).
-   `baseStatistics`: Базовая статистика мероприятия (количество сессий, участников).
-   `recalculationRequired`: Флаг необходимости пересчета баллов сессий.

### EventAccess (Правило доступа)
Доступ к тестированию.

**Поля:**
-   `id`: Уникальный идентификатор доступа.
-   `type`: Тип доступа:
    -   `internal`: Для зарегистрированных пользователей системы.
    -   `external`: Для внешних пользователей (по токену).
    -   `public`: Публичный доступ.
-   `isActive`: Активен ли доступ.
-   `proctoring`: Настройки прокторинга (наблюдение за участником):
    -   `type`: Тип прокторинга (`proctor_edu`).
    -   `templates`: Список шаблонов проверки:
        -   `templateId`: ID шаблона прокторинга.
        -   `label`: Название шаблона.
-   `timeLimits`: Временные ограничения:
    -   `startsAt` / `endsAt`: Время начала и окончания мероприятия.
    -   `onPassDurationMinutes`: Максимальная продолжительность прохождения.
-   `maxAttempts`: Максимальное количество попыток.

### AssignedPlatformAccesses (Назначенные доступы)
Связь между профилем участника, доступом и группой.

**Поля:**
-   `studentProfileId`: ID профиля участника.
-   `accessId`: ID правила доступа.
-   `groupId`: ID группы (опционально).

## API
Основные контроллеры:
-   `EventsController` (`/api/v1/events`): Управление мероприятиями и доступами.
-   `EventsOverviewController` (`/api/v1/sessions-overview`): Обзор и история сессий.
-   `EventsAnalyticsController` (`/api/v1/analytics/events`): Аналитика.
-   `UserEventsController` (`/api/v1/me/events`): Мероприятия текущего пользователя.
-   `EventsCustomerController` (`/api/v1/customer-solver`): Запуск сессий для внешних интеграций.

## Архитектура и реализация

### Основные компоненты
-   **EventsService**: Основной сервис, управляющий жизненным циклом мероприятий.
-   **EventAggregate**: Корневой агрегат. Управляет состоянием мероприятия (`awaiting_participant`, `active`, `finished`), настройками (показ решений, фидбека) и списком доступов (`EventAccessAggregate`).
-   **EventAccessAggregate**: Агрегат доступа. Определяет правила входа (время, прокторинг, тип доступа).

### Команды (Commands)
Модуль активно использует паттерн Command для всех операций изменения состояния.
-   **`CreateEventCommand`**: Создает новое мероприятие.
-   **`EditEventCommand`**: Редактирует настройки мероприятия.
-   **`StartEventCommand` / `StopEventCommand`**: Переводит мероприятие в статус `active` или `finished`.
-   **`DeleteEventCommand`**: Удаляет мероприятие (если оно не активно).
-   **`RecalculateEventSessionsCommand`**: Запускает пересчет баллов для всех сессий мероприятия (например, после изменения весов задач).
-   **`UpdateTaskEventCommand`**: Обновляет задачу внутри мероприятия.
-   **`CreateAccessCommand`**: Создает новое правило доступа.
-   **`EditAccessCommand`**: Редактирует существующий доступ.
-   **`DeleteAccessCommand`**: Удаляет доступ.
-   **`ActivateAccessCommand` / `DeactivateAccessCommand`**: Включает или отключает доступ.
-   **`AssignAccessCommand`**: Назначает доступ конкретной группе или пользователю.
-   **`StartEventSessionCommand`**: Инициализирует сессию решения для участника. Проверяет права доступа, время и попытки.

## Для новых разработчиков

### Структура модуля
```
events/
├── api/                 # Presentation Layer (контроллеры, DTO)
├── infrastructure/     # Infrastructure Layer (реализации интерфейсов)
│   ├── accounts.native.service.ts
│   ├── assigned-access.repository.ts
│   ├── event-access.repository.ts
│   ├── event.repository.ts
│   ├── export.native.service.ts
│   ├── groups.native.service.ts
│   ├── index.ts
│   ├── invites.native.service.ts
│   ├── materials.native.service.ts
│   └── solver.native.service.ts
├── model/               # Domain Layer (сущности, сервисы, интерфейсы)
│   ├── domain/          # Доменные объекты и агрегаты
│   └── services/         # Сервисы уровня приложения
├── services/            # Module Services (специализированные сервисы)
└── index.ts             # Экспорт модуля
```

### Основные потоки данных

1. **Создание мероприятия**:
   - Контроллер EventsController получает запрос на создание
   - EventsService создает экземпляр CreateEventCommand
   - Команда валидирует данные и создает мероприятие в репозитории

2. **Запуск сессии участника**:
   - Контроллер EventsCustomerController получает запрос на запуск сессии
   - StartEventSessionCommand проверяет права доступа и время
   - Если проверки пройдены, создается сессия в модуле Solver

3. **Аналитика мероприятий**:
   - Контроллер EventsAnalyticsController запрашивает статистику
   - OverviewService собирает данные из сессий участников
   - Данные агрегируются и возвращаются клиенту

### Интеграции с другими модулями

- **Solver**: Для запуска сессий решения
- **Accounts**: Для получения данных об участниках и администраторах
- **Groups**: Для работы с группами участников
- **Invites**: Для назначения доступов группам
- **Materials**: Для получения информации о материалах мероприятия
- **Export**: Для экспорта результатов в CSV

### Важные особенности

- Модуль тесно интегрирован с Solver для проведения тестирований
- Поддерживает три типа доступа: внутренний, внешний и публичный
- Реализована интеграция бпрокторингом для контроля за участниками
- Модуль использует Dependency Injection для подключения зависимостей
- Для работы с базой данных используется Prisma ORM
- Все изменения состояния мероприятий происходят через команды
